---
title: å®¹å™¨å†…æŒ‡å®šç‰¹å®šåŸŸåè§£æç»“æœçš„å‡ ç§æ–¹å¼
date: 2023-07-10 16:37:33
tags:
---
åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•åœ¨å®¹å™¨å†…æŒ‡å®šç‰¹å®šåŸŸåè§£æç»“æœçš„å‡ ç§æ–¹å¼ã€‚ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œé¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¼”ç¤ºç”¨çš„Deploymenté…ç½®æ–‡ä»¶ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: busybox-deployment
  labels:
    app: busybox
spec:
  replicas: 1
  selector:
    matchLabels:
      app: busybox
  template:
    metadata:
      labels:
        app: busybox
    spec:
      containers:
      - name: busybox
        image: busybox
        args:
        - /bin/sh
        - -c
        - "while true; do echo Hello, Kubernetes!; sleep 10;done"
```

è¿™ä¸ªdeploymentä¼šåˆ›å»º1ä¸ªbusyboxçš„podï¼Œå®¹å™¨æ¯éš”10sä¼šæ‰“å°â€œHello, Kubernetes!â€åˆ°æ§åˆ¶å°

## TL;DR

| æ–¹æ¡ˆ              | ä¿®æ”¹çº§åˆ«                   | æ˜¯å¦æ¨è  | å¤‡æ³¨                 |
|-----------------|------------------------|-------|--------------------|
| ä¿®æ”¹/etc/hosts    | pod                    | å¦     |                    |
| æ·»åŠ HostAliasesè®°å½• | pod/deploy/statefulset | æ˜¯     |                    |
| ä¿®æ”¹Corednsé…ç½®     | æ•´ä¸ªkubernetesé›†ç¾¤         | æ˜¯     |                    |
| è‡ªå®šä¹‰DNSç­–ç•¥        | pod/deploy/statefulset | è§†æƒ…å†µè€Œå®š | å¦‚éœ€å¯¹æ¥ä¸‰æ–¹çš„DNSæœåŠ¡å™¨ï¼Œæ¨èé‡‡ç”¨ |
| ä½¿ç”¨ä¸‰æ–¹DNSæ’ä»¶       | æ•´ä¸ªkubernetesé›†ç¾¤         | å¦     | ä¸æ¨èï¼ŒCorednsä¸ºä¸šå†…ä¸»æµ   |

## ä¿®æ”¹/etc/hosts

ä¿®æ”¹/etc/hostsæ˜¯æœ€ä¼ ç»Ÿçš„æ–¹å¼ï¼Œç›´æ¥åœ¨å®¹å™¨å†…ä¿®æ”¹ç›¸åº”çš„æ–‡ä»¶æ¥å®ç°åŸŸåè§£æï¼Œåœ¨Podçº§åˆ«ç”Ÿæ•ˆã€‚ç”±äºå…¶å¯ç»´æŠ¤æ€§è¾ƒå·®ï¼ˆæ¯æ¬¡podå‘ç”Ÿé‡å¯éƒ½éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ï¼‰ï¼Œä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨/etc/hostsé‡Œé¢æ·»åŠ è¿™æ ·ä¸€æ¡è®°å½•

```
250.250.250.250 four-250
```

```
/ # ping four-250
PING four-250 (250.250.250.250): 56 data bytes
```

## æ·»åŠ HostAliasesè®°å½•

HostAliasesæ˜¯kubernetesä¸­Podé…ç½®çš„ä¸€ä¸ªå­—æ®µï¼Œå®ƒæä¾›äº†Podå†…å®¹å™¨çš„`/etc/hosts`æ–‡ä»¶çš„é™„åŠ è®°å½•ã€‚è¿™åœ¨æŸäº›æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å½“ä½ æƒ³è¦è¦†ç›–æŸä¸ªä¸»æœºåçš„è§£æç»“æœï¼Œæˆ–è€…æä¾›ç½‘ç»œä¸­æ²¡æœ‰çš„ä¸»æœºåè§£ææ—¶ã€‚

è¿™ä¸ªå¯ä»¥åœ¨Podã€Replicaã€Deploymentã€StatefulSetçš„çº§åˆ«ä¿®æ”¹ï¼Œç»´æŠ¤æ€§ç¨å¼ºã€‚ä¸¾ä¸ªğŸŒ°ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„yamlä¿®æ”¹ä¸º

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: busybox-deployment
  labels:
    app: busybox
spec:
  replicas: 3
  selector:
    matchLabels:
      app: busybox
  template:
    metadata:
      labels:
        app: busybox
    spec:
      hostAliases:
      - ip: "250.250.250.250"
        hostnames:
        - "four-250"
      containers:
      - name: busybox
        image: busybox
        args:
        - /bin/sh
        - -c
        - "while true; do echo Hello, Kubernetes!; sleep 10;done"
```

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æŸ¥çœ‹å®¹å™¨çš„/etc/hostsï¼Œå‘ç°å®ƒè¢«kubernetesè‡ªåŠ¨æ’å…¥äº†ä¸€æ¡è®°å½•**Entries add by HostAliasesã€‚**è¿™å°±æ˜¯hostAliasesçš„å®ç°åŸç†

åœ¨**kubelet_pods**ä»£ç ä¸­è¿›è¡Œäº†è¿™æ ·çš„å†™å…¥åŠ¨ä½œ

```go
func hostsEntriesFromHostAliases(hostAliases []v1.HostAlias) []byte {
	if len(hostAliases) == 0 {
		return []byte{}
	}

	var buffer bytes.Buffer
	buffer.WriteString("\n")
	buffer.WriteString("# Entries added by HostAliases.\n")
	// for each IP, write all aliases onto single line in hosts file
	for _, hostAlias := range hostAliases {
		buffer.WriteString(fmt.Sprintf("%s\t%s\n", hostAlias.IP, strings.Join(hostAlias.Hostnames, "\t")))
	}
	return buffer.Bytes()
}
```

## Corednsé…ç½®

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ConfigMapæ¥å®ç°è®©å®¹å™¨è§£æç‰¹å®šåŸŸåçš„ç›®çš„ã€‚

### æ›´æ”¹Corednsé…ç½®

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹Corednsçš„é…ç½®ï¼š

```bash
kubectl edit cm coredns -n kube-system
```

### åŸæœ‰çš„configmap

```yaml
Corefile: |
    .:53 {
        log
        errors
        health {
           lameduck 5s
        }
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        prometheus :9153
        hosts {
           192.168.65.2 host.minikube.internal
           fallthrough
        }
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        cache 30
        loop
        reload
        loadbalance
    }
```

åœ¨hostsé‡Œé¢åŠ ä¸Šç‰¹å®šçš„è®°å½•

```
250.250.250.250 four-250
```

å¦‚æœæ‚¨æ²¡æœ‰é…ç½®reloadæ’ä»¶ï¼Œåˆ™éœ€è¦é‡å¯Corednsæ‰èƒ½ç”Ÿæ•ˆï¼Œé»˜è®¤çš„reloadæ—¶é—´æ˜¯30sï¼Œåœ¨plugin/reload/setup.goçš„defaultIntervalä¸­å®šä¹‰

## è‡ªå®šä¹‰DNSç­–ç•¥

é€šè¿‡ä¿®æ”¹DNSç­–ç•¥ã€‚ä½¿å¾—å¯¹äºå•ä¸ªPod/Deploy/StatefulSetå°†ç‰¹å®šçš„åŸŸåè§£æå‘ç»™ç‰¹å®šçš„æœåŠ¡å™¨æ¥è¾¾åˆ°æ•ˆæœï¼Œå¦‚ä¸‹ï¼Œå¯ä»¥å¯¹podæ·»åŠ dnsçš„æœåŠ¡å™¨ä»¥åŠsearchåŸŸ

```yaml
   spec:
      dnsConfig:
        nameservers:
          - 1.2.3.4
        searches:
          - search.prefix
      containers:
      - name: busybox
        image: busybox
        args:
        - /bin/sh
        - -c
        - "while true; do echo Hello, Kubernetes!; sleep 10;done"
```

## ä½¿ç”¨ç¬¬ä¸‰æ–¹DNSæ’ä»¶

ä¸æ¨èï¼Œä½¿ç”¨å…¶ä»–çš„DNSæ’ä»¶ï¼Œæ¥åšä¸€äº›ç‚«é…·çš„è‡ªå®šä¹‰æ“ä½œã€‚è€Œä¸”ç›®å‰Corednsä¹Ÿæ˜¯ä¸šå†…çš„ä¸»æµï¼Œæ²¡æœ‰å¾ˆå¥½çš„æ›¿ä»£
